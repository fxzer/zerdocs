import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.dfc91c2c.js";const C=JSON.parse('{"title":"Node大文件上传","description":"","frontmatter":{},"headers":[],"relativePath":"BackEnd/NodeJS/Node大文件上传.md","filePath":"BackEnd/NodeJS/Node大文件上传.md"}'),p={name:"BackEnd/NodeJS/Node大文件上传.md"},o=l(`<h1 id="node大文件上传" tabindex="-1">Node大文件上传 <a class="header-anchor" href="#node大文件上传" aria-label="Permalink to &quot;Node大文件上传&quot;">​</a></h1><ol><li>创建文件唯一 HASH</li><li>发请求检查文件是否已传过 <ol><li>传过:提示&#39;秒传成功&#39;</li><li>未传过:开始切片并上传，创建任务池，循环上传切片</li><li>传过未传完:从下一切片开始传</li></ol></li><li>上传完成，发送合并切片请求</li></ol><h2 id="vue-前端代码" tabindex="-1">Vue 前端代码 <a class="header-anchor" href="#vue-前端代码" aria-label="Permalink to &quot;Vue 前端代码&quot;">​</a></h2><div class="language-vue vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">template</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">el-upload</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">:http-request</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">customRequest</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">template</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">#</span><span style="color:#80A665;">trigger</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">el-button</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">primary</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;</span><span style="color:#DBD7CAEE;">选择文件</span><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">el-button</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">template</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">el-upload</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">template</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">script</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lang</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">ts</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">setup</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">axios</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">axios</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SparkMD5</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">spark-md5</span><span style="color:#C98A7D99;">&#39;</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">customRequest</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> async </span><span style="color:#666666;">({</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">file</span><span style="color:#CB7676;"> </span><span style="color:#666666;">})</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">formData</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">FormData</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">formData</span><span style="color:#666666;">.</span><span style="color:#80A665;">append</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">fileName</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">file</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">hash</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">calcFileHash</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">chunks</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">createFileChunk</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 检查文件是否存在</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// const { data: { data: { exist } } } = await checkFileExist(hash)</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">res</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">uploadChunks</span><span style="color:#666666;">(</span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">checkFileExist</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">hash</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">axios</span><span style="color:#666666;">.</span><span style="color:#80A665;">post</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">http://localhost:3000/upload/checkFile</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#BD976A;">hash</span></span>
<span class="line"><span style="color:#666666;">  })</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA994;">Chunk</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">name</span><span style="color:#666666;">: </span><span style="color:#5DA994;">string</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">index</span><span style="color:#666666;">: </span><span style="color:#5DA994;">number</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">chunk</span><span style="color:#666666;">: </span><span style="color:#5DA994;">Blob</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">: </span><span style="color:#5DA994;">string</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">ChunkSize</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">1024</span><span style="color:#CB7676;"> * </span><span style="color:#4C9A91;">1024</span><span style="color:#CB7676;"> * </span><span style="color:#4C9A91;">2</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">// 2M</span></span>
<span class="line"><span style="color:#758575DD;">// 创建分片</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">createFileChunk</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">: </span><span style="color:#5DA994;">Chunk</span><span style="color:#666666;">[] =</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[]</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">chunkCount</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">Math</span><span style="color:#666666;">.</span><span style="color:#80A665;">ceil</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#BD976A;">size</span><span style="color:#CB7676;"> / </span><span style="color:#BD976A;">ChunkSize</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">for</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> </span><span style="color:#666666;">&lt;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">chunkCount</span><span style="color:#666666;">;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">chunk</span><span style="color:#666666;">: </span><span style="color:#5DA994;">Blob</span><span style="color:#666666;"> =</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> * </span><span style="color:#BD976A;">ChunkSize</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> + </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> * </span><span style="color:#BD976A;">ChunkSize</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">name</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#CB7676;"> + </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">-</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> + </span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#666666;">.</span><span style="color:#80A665;">substring</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#666666;">.</span><span style="color:#80A665;">lastIndexOf</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">.</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> + </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#BD976A;">name</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#B8A965;">index</span><span style="color:#666666;">: </span><span style="color:#BD976A;">i</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#BD976A;">chunk</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    })</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">chunks</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#758575DD;">// 创建文件hash值</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">calcFileHash</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">: </span><span style="color:#5DA994;">File</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> new </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">resolve</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">spark</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#BD976A;">SparkMD5</span><span style="color:#666666;">.</span><span style="color:#80A665;">ArrayBuffer</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">reader</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">FileReader</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">size</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#BD976A;">size</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">offset</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">2</span><span style="color:#CB7676;"> * </span><span style="color:#4C9A91;">1024</span><span style="color:#CB7676;"> * </span><span style="color:#4C9A91;">1024</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 第一个2M，最后一个区块数据全要</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">chunks</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#4C9A91;">0</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">offset</span><span style="color:#666666;">)]</span></span>
<span class="line"><span style="color:#CB7676;">    let </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">offset</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">while</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> </span><span style="color:#666666;">&lt;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">size</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">offset</span><span style="color:#CB7676;"> </span><span style="color:#666666;">&gt;=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">size</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 最后一个区快</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">cur</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">offset</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#666666;">}</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">else</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 中间的区块</span></span>
<span class="line"><span style="color:#CB7676;">        const </span><span style="color:#BD976A;">mid</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">offset</span><span style="color:#CB7676;"> / </span><span style="color:#4C9A91;">2</span></span>
<span class="line"><span style="color:#CB7676;">        const </span><span style="color:#BD976A;">end</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> + </span><span style="color:#BD976A;">offset</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">cur</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> + </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">mid</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">mid</span><span style="color:#CB7676;"> + </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">file</span><span style="color:#666666;">.</span><span style="color:#80A665;">slice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">end</span><span style="color:#CB7676;"> - </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">end</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">cur</span><span style="color:#CB7676;"> += </span><span style="color:#BD976A;">offset</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 中间的，取前中后各2各字节</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">reader</span><span style="color:#666666;">.</span><span style="color:#80A665;">readAsArrayBuffer</span><span style="color:#666666;">(</span><span style="color:#CB7676;">new </span><span style="color:#80A665;">Blob</span><span style="color:#666666;">(</span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">reader</span><span style="color:#666666;">.</span><span style="color:#80A665;">onload</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">e</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">spark</span><span style="color:#666666;">.</span><span style="color:#80A665;">append</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">?.</span><span style="color:#BD976A;">target</span><span style="color:#666666;">?.</span><span style="color:#BD976A;">result</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">as</span><span style="color:#CB7676;"> </span><span style="color:#5DA994;">ArrayBuffer</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">spark</span><span style="color:#666666;">.</span><span style="color:#80A665;">end</span><span style="color:#666666;">())</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#758575DD;">// 上传分片</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">uploadChunks</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> async </span><span style="color:#666666;">(</span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">: </span><span style="color:#5DA994;">Array</span><span style="color:#666666;">&lt;</span><span style="color:#5DA994;">Chunk</span><span style="color:#666666;">&gt;,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">: </span><span style="color:#5DA994;">string</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 转成promise</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">requestList</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">chunks</span><span style="color:#666666;">.</span><span style="color:#80A665;">map</span><span style="color:#666666;">(({</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">chunk</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">name</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">index</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#CB7676;"> </span><span style="color:#666666;">})</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">form</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">FormData</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">form</span><span style="color:#666666;">.</span><span style="color:#80A665;">append</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">chunk</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">chunk</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">name</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">form</span><span style="color:#666666;">.</span><span style="color:#80A665;">append</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">hash</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">hash</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">form</span><span style="color:#666666;">.</span><span style="color:#80A665;">append</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">name</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">name</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{ </span><span style="color:#BD976A;">form</span><span style="color:#666666;">, </span><span style="color:#B8A965;">index</span><span style="color:#666666;">: </span><span style="color:#BD976A;">index</span><span style="color:#666666;">, </span><span style="color:#B8A965;">error</span><span style="color:#666666;">: </span><span style="color:#4C9A91;">0</span><span style="color:#666666;"> }</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">  let </span><span style="color:#BD976A;">index</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">0</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">: </span><span style="color:#5DA994;">Array</span><span style="color:#666666;">&lt;</span><span style="color:#5DA994;">Promise</span><span style="color:#666666;">&lt;</span><span style="color:#5DA994;">any</span><span style="color:#666666;">&gt;&gt; =</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[]</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">max</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">6</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">// 设置浏览器运行最大并发数  目前6个为当前的主流</span></span>
<span class="line"><span style="color:#CB7676;">  let </span><span style="color:#BD976A;">allProgress</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">index</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">// 总进度</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">while</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">index</span><span style="color:#CB7676;"> </span><span style="color:#666666;">&lt;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">requestList</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    const </span><span style="color:#BD976A;">task</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">axios</span><span style="color:#666666;">.</span><span style="color:#80A665;">post</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">http://localhost:3000/upload/postFile</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">requestList</span><span style="color:#666666;">[</span><span style="color:#BD976A;">index</span><span style="color:#666666;">].</span><span style="color:#BD976A;">form</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#80A665;">onUploadProgress</span><span style="color:#666666;">: (</span><span style="color:#BD976A;">progress</span><span style="color:#666666;">) =&gt; {</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#BD976A;">allProgress</span><span style="color:#666666;"> </span><span style="color:#CB7676;">+=</span><span style="color:#666666;"> (</span><span style="color:#BD976A;">progress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">loaded</span><span style="color:#666666;"> </span><span style="color:#CB7676;">/</span><span style="color:#666666;"> (</span><span style="color:#BD976A;">progress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">total</span><span style="color:#666666;"> </span><span style="color:#CB7676;">?</span><span style="color:#666666;"> </span><span style="color:#BD976A;">progress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">total</span><span style="color:#666666;"> </span><span style="color:#CB7676;">:</span><span style="color:#666666;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)) </span><span style="color:#758575DD;">// 这是单个分片的</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">percent</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">((</span><span style="color:#BD976A;">allProgress</span><span style="color:#CB7676;"> / </span><span style="color:#BD976A;">requestList</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> * </span><span style="color:#4C9A91;">100</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// if (params.onProgress) params.onProgress({ percent })</span></span>
<span class="line"><span style="color:#666666;">      }</span></span>
<span class="line"><span style="color:#666666;">    })</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">task</span><span style="color:#666666;">.</span><span style="color:#80A665;">then</span><span style="color:#666666;">(()</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">.</span><span style="color:#80A665;">splice</span><span style="color:#666666;">(</span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">.</span><span style="color:#80A665;">findIndex</span><span style="color:#666666;">(</span><span style="color:#BD976A;">item</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">item</span><span style="color:#CB7676;"> === </span><span style="color:#BD976A;">task</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">task</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#CB7676;"> === </span><span style="color:#BD976A;">max</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">.</span><span style="color:#80A665;">race</span><span style="color:#666666;">(</span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">// 竞赛等出一个执行完毕的请求</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#BD976A;">index</span><span style="color:#CB7676;">++</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">[ taskPool ]-95</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">.</span><span style="color:#80A665;">all</span><span style="color:#666666;">(</span><span style="color:#BD976A;">taskPool</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">script</span><span style="color:#666666;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">style</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">scoped</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lang</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">scss</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">.</span><span style="color:#BD976A;">upload-demo</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">margin</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">100</span><span style="color:#CB7676;">px</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">100</span><span style="color:#CB7676;">px</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">&lt;/</span><span style="color:#4D9375;">style</span><span style="color:#666666;">&gt;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">template</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">el-upload</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">:http-request</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">customRequest</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">template</span><span style="color:#393A34;"> </span><span style="color:#999999;">#</span><span style="color:#59873A;">trigger</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">el-button</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">primary</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;</span><span style="color:#393A34;">选择文件</span><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">el-button</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">template</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">el-upload</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">template</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">script</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lang</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">ts</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">setup</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">axios</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">axios</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SparkMD5</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">spark-md5</span><span style="color:#B5695999;">&#39;</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">customRequest</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> async </span><span style="color:#999999;">({</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">file</span><span style="color:#AB5959;"> </span><span style="color:#999999;">})</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">formData</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">FormData</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">formData</span><span style="color:#999999;">.</span><span style="color:#59873A;">append</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">fileName</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">file</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">hash</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">calcFileHash</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">chunks</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">createFileChunk</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 检查文件是否存在</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// const { data: { data: { exist } } } = await checkFileExist(hash)</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">res</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">uploadChunks</span><span style="color:#999999;">(</span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">checkFileExist</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">hash</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">axios</span><span style="color:#999999;">.</span><span style="color:#59873A;">post</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">http://localhost:3000/upload/checkFile</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#B07D48;">hash</span></span>
<span class="line"><span style="color:#999999;">  })</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E8F82;">Chunk</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">name</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">string</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">index</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">number</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">chunk</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">Blob</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">string</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">ChunkSize</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">1024</span><span style="color:#AB5959;"> * </span><span style="color:#2F798A;">1024</span><span style="color:#AB5959;"> * </span><span style="color:#2F798A;">2</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">// 2M</span></span>
<span class="line"><span style="color:#A0ADA0;">// 创建分片</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">createFileChunk</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">Chunk</span><span style="color:#999999;">[] =</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[]</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">chunkCount</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">Math</span><span style="color:#999999;">.</span><span style="color:#59873A;">ceil</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#B07D48;">size</span><span style="color:#AB5959;"> / </span><span style="color:#B07D48;">ChunkSize</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">for</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> </span><span style="color:#999999;">&lt;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">chunkCount</span><span style="color:#999999;">;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">chunk</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">Blob</span><span style="color:#999999;"> =</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> * </span><span style="color:#B07D48;">ChunkSize</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> + </span><span style="color:#2F798A;">1</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> * </span><span style="color:#B07D48;">ChunkSize</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">name</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#AB5959;"> + </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">-</span><span style="color:#B5695999;">&quot;</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> + </span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.</span><span style="color:#B5695999;">&quot;</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#999999;">.</span><span style="color:#59873A;">substring</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#999999;">.</span><span style="color:#59873A;">lastIndexOf</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">.</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> + </span><span style="color:#2F798A;">1</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#B07D48;">name</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#998418;">index</span><span style="color:#999999;">: </span><span style="color:#B07D48;">i</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#B07D48;">chunk</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    })</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">chunks</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#A0ADA0;">// 创建文件hash值</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">calcFileHash</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">File</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> new </span><span style="color:#998418;">Promise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">resolve</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">spark</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#B07D48;">SparkMD5</span><span style="color:#999999;">.</span><span style="color:#59873A;">ArrayBuffer</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">reader</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">FileReader</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">size</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#B07D48;">size</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">offset</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">2</span><span style="color:#AB5959;"> * </span><span style="color:#2F798A;">1024</span><span style="color:#AB5959;"> * </span><span style="color:#2F798A;">1024</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 第一个2M，最后一个区块数据全要</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">chunks</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#2F798A;">0</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">offset</span><span style="color:#999999;">)]</span></span>
<span class="line"><span style="color:#AB5959;">    let </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">offset</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">while</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> </span><span style="color:#999999;">&lt;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">size</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">offset</span><span style="color:#AB5959;"> </span><span style="color:#999999;">&gt;=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">size</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 最后一个区快</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">cur</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">offset</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#999999;">}</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">else</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 中间的区块</span></span>
<span class="line"><span style="color:#AB5959;">        const </span><span style="color:#B07D48;">mid</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">offset</span><span style="color:#AB5959;"> / </span><span style="color:#2F798A;">2</span></span>
<span class="line"><span style="color:#AB5959;">        const </span><span style="color:#B07D48;">end</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> + </span><span style="color:#B07D48;">offset</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">cur</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> + </span><span style="color:#2F798A;">2</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">mid</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">mid</span><span style="color:#AB5959;"> + </span><span style="color:#2F798A;">2</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">file</span><span style="color:#999999;">.</span><span style="color:#59873A;">slice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">end</span><span style="color:#AB5959;"> - </span><span style="color:#2F798A;">2</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">end</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">cur</span><span style="color:#AB5959;"> += </span><span style="color:#B07D48;">offset</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 中间的，取前中后各2各字节</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">reader</span><span style="color:#999999;">.</span><span style="color:#59873A;">readAsArrayBuffer</span><span style="color:#999999;">(</span><span style="color:#AB5959;">new </span><span style="color:#59873A;">Blob</span><span style="color:#999999;">(</span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">reader</span><span style="color:#999999;">.</span><span style="color:#59873A;">onload</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">e</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">spark</span><span style="color:#999999;">.</span><span style="color:#59873A;">append</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">?.</span><span style="color:#B07D48;">target</span><span style="color:#999999;">?.</span><span style="color:#B07D48;">result</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">as</span><span style="color:#AB5959;"> </span><span style="color:#2E8F82;">ArrayBuffer</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">spark</span><span style="color:#999999;">.</span><span style="color:#59873A;">end</span><span style="color:#999999;">())</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#A0ADA0;">// 上传分片</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">uploadChunks</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> async </span><span style="color:#999999;">(</span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">Array</span><span style="color:#999999;">&lt;</span><span style="color:#2E8F82;">Chunk</span><span style="color:#999999;">&gt;,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">string</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 转成promise</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">requestList</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">chunks</span><span style="color:#999999;">.</span><span style="color:#59873A;">map</span><span style="color:#999999;">(({</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">chunk</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">name</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">index</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#AB5959;"> </span><span style="color:#999999;">})</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">form</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">FormData</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">form</span><span style="color:#999999;">.</span><span style="color:#59873A;">append</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">chunk</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">chunk</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">name</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">form</span><span style="color:#999999;">.</span><span style="color:#59873A;">append</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">hash</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">hash</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">form</span><span style="color:#999999;">.</span><span style="color:#59873A;">append</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">name</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">name</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{ </span><span style="color:#B07D48;">form</span><span style="color:#999999;">, </span><span style="color:#998418;">index</span><span style="color:#999999;">: </span><span style="color:#B07D48;">index</span><span style="color:#999999;">, </span><span style="color:#998418;">error</span><span style="color:#999999;">: </span><span style="color:#2F798A;">0</span><span style="color:#999999;"> }</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">  let </span><span style="color:#B07D48;">index</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">0</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">: </span><span style="color:#2E8F82;">Array</span><span style="color:#999999;">&lt;</span><span style="color:#2E8F82;">Promise</span><span style="color:#999999;">&lt;</span><span style="color:#2E8F82;">any</span><span style="color:#999999;">&gt;&gt; =</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[]</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">max</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">6</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">// 设置浏览器运行最大并发数  目前6个为当前的主流</span></span>
<span class="line"><span style="color:#AB5959;">  let </span><span style="color:#B07D48;">allProgress</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">index</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">// 总进度</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">while</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">index</span><span style="color:#AB5959;"> </span><span style="color:#999999;">&lt;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">requestList</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    const </span><span style="color:#B07D48;">task</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">axios</span><span style="color:#999999;">.</span><span style="color:#59873A;">post</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">http://localhost:3000/upload/postFile</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">requestList</span><span style="color:#999999;">[</span><span style="color:#B07D48;">index</span><span style="color:#999999;">].</span><span style="color:#B07D48;">form</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#59873A;">onUploadProgress</span><span style="color:#999999;">: (</span><span style="color:#B07D48;">progress</span><span style="color:#999999;">) =&gt; {</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#B07D48;">allProgress</span><span style="color:#999999;"> </span><span style="color:#AB5959;">+=</span><span style="color:#999999;"> (</span><span style="color:#B07D48;">progress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">loaded</span><span style="color:#999999;"> </span><span style="color:#AB5959;">/</span><span style="color:#999999;"> (</span><span style="color:#B07D48;">progress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">total</span><span style="color:#999999;"> </span><span style="color:#AB5959;">?</span><span style="color:#999999;"> </span><span style="color:#B07D48;">progress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">total</span><span style="color:#999999;"> </span><span style="color:#AB5959;">:</span><span style="color:#999999;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">)) </span><span style="color:#A0ADA0;">// 这是单个分片的</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">percent</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">((</span><span style="color:#B07D48;">allProgress</span><span style="color:#AB5959;"> / </span><span style="color:#B07D48;">requestList</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> * </span><span style="color:#2F798A;">100</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// if (params.onProgress) params.onProgress({ percent })</span></span>
<span class="line"><span style="color:#999999;">      }</span></span>
<span class="line"><span style="color:#999999;">    })</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">task</span><span style="color:#999999;">.</span><span style="color:#59873A;">then</span><span style="color:#999999;">(()</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">.</span><span style="color:#59873A;">splice</span><span style="color:#999999;">(</span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">.</span><span style="color:#59873A;">findIndex</span><span style="color:#999999;">(</span><span style="color:#B07D48;">item</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">item</span><span style="color:#AB5959;"> === </span><span style="color:#B07D48;">task</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">task</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#AB5959;"> === </span><span style="color:#B07D48;">max</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">.</span><span style="color:#59873A;">race</span><span style="color:#999999;">(</span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">// 竞赛等出一个执行完毕的请求</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#B07D48;">index</span><span style="color:#AB5959;">++</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">[ taskPool ]-95</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">.</span><span style="color:#59873A;">all</span><span style="color:#999999;">(</span><span style="color:#B07D48;">taskPool</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">script</span><span style="color:#999999;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">style</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">scoped</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lang</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">scss</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">.</span><span style="color:#B07D48;">upload-demo</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">margin</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">100</span><span style="color:#AB5959;">px</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">100</span><span style="color:#AB5959;">px</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">&lt;/</span><span style="color:#1E754F;">style</span><span style="color:#999999;">&gt;</span></span></code></pre></div>`,4),e=[o];function c(t,r,y,B,A,D){return n(),a("div",null,e)}const u=s(p,[["render",c]]);export{C as __pageData,u as default};
